{% extends "base.html" %}
{% block content %}
<h1>Stock Market</h1>

<!-- Optional alert for market status -->
<div id="market-status" class="alert alert-info" style="display: none;"></div>

<table class="table">
  <thead>
    <tr>
      <th>Company</th>
      <th>Symbol</th>
      <th>Price</th>
      <th>Available Volume</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody>
    {% for stock in stocks %}
    <tr>
      <td>{{ stock.company_name }}</td>
      <td>{{ stock.symbol }}</td>
      <td>${{ "%.2f"|format(stock.price) }}</td>
      <td>{{ stock.volume }}</td>
      <td>
        <form action="{{ url_for('buy_stock', stock_id=stock.id) }}" method="POST" class="d-inline">
          <input type="number" name="quantity" value="1" min="0.1" step="any" class="form-control d-inline" style="width: 80px;">
          <button class="btn btn-primary btn-sm">Buy</button>
        </form>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<a href="{{ url_for('portfolio') }}" class="btn btn-secondary">View Portfolio</a>

<!--  Market hour logic -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const now = new Date();
  const currentHour = now.getHours() + now.getMinutes() / 60;
  const day = now.getDay(); 

  // Market open hours (9:30 AM â€“ 4:00 PM)
  const marketOpen = 9.5;
  const marketClose = 16.0;

  // Holidays (YYYY-MM-DD)
  const holidays = ["2025-01-01", "2025-07-04", "2025-12-25"];
  const today = now.toISOString().split("T")[0];

  // Determine if market is closed
  let marketClosed = false;
  if (day === 0 || day === 6) marketClosed = true; 
  if (currentHour < marketOpen || currentHour > marketClose) marketClosed = true;
  if (holidays.includes(today)) marketClosed = true;

  // Disable Buy buttons and show banner
  const statusDiv = document.getElementById("market-status");
  if (marketClosed) {
    document.querySelectorAll("button.btn-primary").forEach(btn => {
      btn.disabled = true;
      btn.title = "Market closed. Try again during market hours.";
    });
    statusDiv.textContent = " The market is currently closed. Trading is available on weekdays between 9:30 AM and 4:00 PM.";
    statusDiv.classList.replace("alert-info", "alert-warning");
    statusDiv.style.display = "block";
  } else {
    statusDiv.textContent = " Market is open for trading.";
    statusDiv.style.display = "block";
  }
});
</script>

{% endblock %}